<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<title>Fieldmap Tirol - Viehbergung</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  font-family: 'Akagi Pro', sans-serif; /* Schriftart */
}

#map {
  height: 80vh;
  width: 100%;
  touch-action: none;
}

.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin: 10px;
}

.controls button, .controls label, .layer-switch {
  font-size: 1.2em;
  padding: 8px 12px;
  cursor: pointer;
}

#coords {
  margin: 10px;
  font-size: 1em;
}
</style>
</head>
<body>

<h3>Fieldmap Tirol - Tierbergung</h3>

<div class="controls">
  <label><input type="radio" name="type" value="Lebendvieh" checked> Lebendviehbergung</label>
  <label><input type="radio" name="type" value="Kadaver"> Kadaverbergung</label>
  <button id="reset">Zur√ºcksetzen</button>
  <button id="exportPDF">Als PDF exportieren</button>
  <button id="exportJPG">Als JPG exportieren</button>
  <select id="layerSwitch" class="layer-switch">
    <option value="osm">OSM-Karte</option>
    <option value="topo">Topographische Karte</option>
  </select>
</div>

<div id="map"></div>
<p id="coords"></p>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
console.log("Test"); // Pr√ºfen ob JS geladen wird

// Karte initialisieren (Fokus Tirol)
const map = L.map('map', {
  zoomControl: true,
  dragging: true,
  tap: true,
  touchZoom: true,
  doubleClickZoom: false
}).setView([47.26, 11.40], 9);

// Layer definieren
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '¬© OpenStreetMap',
  crossOrigin: true
});

const topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
  maxZoom: 17,
  attribution: '¬© OpenTopoMap (CC-BY-SA)',
  crossOrigin: true
});

// Standardlayer hinzuf√ºgen
osm.addTo(map);

// Layer-Switch
const baseLayers = {
  "osm": osm,
  "topo": topo
};

document.getElementById("layerSwitch").addEventListener('change', (e) => {
  Object.values(baseLayers).forEach(layer => map.removeLayer(layer));
  baseLayers[e.target.value].addTo(map);
});

// Marker und Punkte
let points = [];
let markers = [];

// Karte klicken ‚Üí Marker setzen
map.on('click', function(e) {
  if (points.length >= 2) return alert("Nur zwei Punkte erlaubt (Aufnahme & Ablage).");

  const label = points.length === 0 ? "Aufnahmeort" : "Ablageort";
  const marker = L.marker(e.latlng).addTo(map).bindPopup(label).openPopup();
  markers.push(marker);
  points.push(e.latlng);

  updateCoords();
});

// Koordinaten anzeigen
function updateCoords() {
  let text = "";
  if (points[0]) text += `üìç Aufnahmeort: ${points[0].lat.toFixed(5)}, ${points[0].lng.toFixed(5)}<br>`;
  if (points[1]) text += `üìç Ablageort: ${points[1].lat.toFixed(5)}, ${points[1].lng.toFixed(5)}`;
  document.getElementById("coords").innerHTML = text;
}

// Zur√ºcksetzen
document.getElementById("reset").onclick = () => {
  points = [];
  markers.forEach(m => map.removeLayer(m));
  markers = [];
  document.getElementById("coords").innerHTML = "";
};

// PDF Export
document.getElementById("exportPDF").onclick = async () => {
  if (points.length < 2) return alert("Bitte zwei Punkte setzen.");
  const type = document.querySelector('input[name="type"]:checked').value;
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

  html2canvas(map.getContainer(), {useCORS: true}).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
    pdf.text(`Fieldmap Tirol - ${type}`, 10, 10);
    pdf.addImage(imgData, 'PNG', 10, 20, 260, 140);
    pdf.text(`Aufnahmeort: ${points[0].lat.toFixed(5)}, ${points[0].lng.toFixed(5)}`, 10, 170);
    pdf.text(`Ablageort:   ${points[1].lat.toFixed(5)}, ${points[1].lng.toFixed(5)}`, 10, 180);
    const now = new Date();
    pdf.text(`Datum: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`, 10, 190);
    pdf.save(`fieldmap_Tirol_${type}.pdf`);
  });
};

// JPG Export
document.getElementById("exportJPG").onclick = async () => {
  if (points.length < 2) return alert("Bitte zwei Punkte setzen.");
  html2canvas(map.getContainer(), {useCORS: true}).then(canvas => {
    const link = document.createElement("a");
    link.download = `fieldmap_Tirol.jpg`;
    link.href = canvas.toDataURL("image/jpeg", 1.0);
    link.click();
  });
};

// Karte dynamisch an Bildschirmh√∂he anpassen
function resizeMap() {
  const height = window.innerHeight * 0.8;
  document.getElementById('map').style.height = height + "px";
  map.invalidateSize();
}

window.addEventListener('resize', resizeMap);
resizeMap();

</script>
</body>
</html>

